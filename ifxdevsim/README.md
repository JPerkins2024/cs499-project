# IFXdevsim 

Devsim is a batch simulation engine that is able to simulate metrics and curves in multiple simulators.  It is primarily configured through DSI yaml files and references a technology file (techfile) in order to get key information
about a device to avoid repitition.  Devsim currently supports simulation in the following simulators:

* eldo 
* hspice
* xa (limited support)
* spectre
* titan


## Install (Development)
Clone this repo and run the following command:
`pip install -e .`

The current entry point is ifxdevsim/src/\_\_init\_\_.py's main function.  This is bound to the "dvsim" executable.  After installation you should be able to run `dvsim` (may need to source cshrc to update path).


## Test:

Unit tests are set up using pytest.  To run, ensure you are running the correct version of python by running `module load MDL_python` and run:

`pytest`




Implement tests for a file under the same relative path under `tests` as it is under `src`.  Test files must begin with `test_` or end with `_test.py` in order to be picked up by pytest.
See [the pytest documentation](https://docs.pytest.org/en/6.2.x/goodpractices.html) for details.

## Usage
### Command line
```

usage: dvsim [-h] [-i INPUT] [-s SAMPLE] [-ms MEAS_SCALE] [-w] [-r] [-uo]
             [-m MEAS] [-md MEAS_DRY] [-d] [-mf [MEAS_FROM]]
             [-mdsi [MEAS_DSI]] [-mkop [MEAS_KOP]] [-print-metric-routines]
             [-print-view-config CONFIG_TO_PRINT] [-print-valid-views]
             [-tf TECHFILE] [-pdf PDF] [-vo]

optional arguments:
  -h, --help            show this help message and exit
  -i INPUT, --input INPUT
  -s SAMPLE, --sample SAMPLE
  -ms MEAS_SCALE, --meas_scale MEAS_SCALE
                        Scales measurement parameters by this factor.
  -w, --workspace
  -r, --report          Generate LaTex report with new or existing .yal layout
                        file
  -uo, --uniq_only      Only uniquify parameters and write unique dsi.yml
  -m MEAS, --meas MEAS  toplevel meas directory. With -md option, writes
                        replay file and quits. Without, goes directly to dsi
                        file. Currently only supports mdm files.
  -md MEAS_DRY, --meas_dry MEAS_DRY
                        write meas_input_list.replay and quit
  -d, --debug           Enable debug output/behavior
  -mf [MEAS_FROM], --meas_from [MEAS_FROM]
                        read meas_input_list.replay and generate dsi
  -mdsi [MEAS_DSI], --meas_dsi [MEAS_DSI]
                        Name of dsi file generated from measurements
  -mkop [MEAS_KOP], --meas_kop [MEAS_KOP]
                        Name of dsi kop file generated from measurements
  -print-metric-routines, --print-metric-routines
                        Print valid metric routines used for techfile
                        configuration and exit
  -print-view-config CONFIG_TO_PRINT, --print-view-config CONFIG_TO_PRINT
                        Print viewconfig and exit. Use --print-valid-views for
                        valid arguments
  -print-valid-views, --print-valid-views
                        Print valid viewtypes and exit
  -tf TECHFILE, --techfile TECHFILE
                        Name of techfile if not relying on autodiscovery. To
                        force without using this, add the relative path to the
                        techfile into .techfile in the current directory.
  -pdf PDF, --combine-pdfs PDF
                        Combine generated pdfs into single file for easy
                        viewing
  -vo, --views-only     Only create views from previously run simulations
```
### User Setup
Devsim works best if you configure a techfile for the technology you are working on.  The [pytechdata](https://bitbucket.vih.infineon.com/projects/MDL_SOFTWARE/repos/pytechdata/browse) package can be used to help generate a techfile.  However, manual simulation is possible if a techfile is not available.
#### DSI files
DSI files are the input files to devsim written in the YAML format.  They can be generated from measurements using the -mdsi and -mkop arguments, or written manually.  If a user is familiar with the ruby-style devsim, they can also be generated from techfile information using the ruby devsim's `devsim -s <filename>.dsi.yml`.  
This requires a devsim.tf techfile, which can be generated by the pytechdata package and is a custom techfile format previously used in the ruby version of devsim.  A feature similar to this is planned for ifxpydevsim.
Basic components inside of a DSI file are `Parameters`, which are a top-level dictionary in the dsi yaml file.  Internally, there are several potential components to a parameter that can be defined: 
* definitions (dict): Contains values that are either key words related to devsim's operation, or aliases that can be used in other components
* stimuli (dict): Contains biases that will be applied to each port defined in definitions: ports.  Basic definition is v\<port\> or i\<port\>
* instance parameters (dict): Contains values that will be passed to the device's instance line
* control (dict): Contains values that are unique to a single simulation deck.
* device (str): device name that is defined in techfile.  Default values and definition lookups are merged from the techfile device.
* metrics (str) (optional): Use a pre-configured metric defined in the techfile, which will apply the appropriate values to stimuli and definitions.
* views (dict) (optional): By default devsim writes a dso.yml, which is not easily readable.  Views are configured to filter and organize data.  Two view examples are csv and texgraph.
* sweep (dict) (optional): If generating a graph, instructs devsim which field is expected to be the x-axis and which is to be the secondary axis.

Any type can be arrayed or converted into a list of dictionaries, and will be autoexpanded into unique parameters.
Details/examples can be found in [doc/dsi.md](./doc/dsi.md).
#### Simulation Flow
Devsim follows this basic flow:
1. Read in all dsi input files.  If no argument is given, find all files hierarchically, and write devsim.replay.  If devsim.replay exists, it is used as the input if no arguments are given.  A keyword parameter 'default' is merged into all other parameters in their respective dsi file.  A keyword parameter 'override' can be used to optionally override all values for a field if needed for an experiment.
2. Uniquify all parameters that have lists or dictionaries in values.
3. Group parameters based on control section, each matching section is equivalent to one corner set of sim decks.  Run directories are created in /opt/tmp_share/\<your\_name\>/devsim.  A link to this area is created under ./work, and a unique name based on launch machine and pid is created.
4. Netlist and launch jobs.  A dummy job that runs `cat /dev/null` is launched to hold flow control while jobs finish.
5. Parse output measures and logfiles.  Print any errors, and write the corresponding dso.yml files.  Each input .dsi.yml will have a corresponding .dso.yml.  View generation does not obey this rule.
6. Generate views.
